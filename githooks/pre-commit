#!/bin/sh

# 遇到错误立即退出
set -e

# 1. 确保在 Git 仓库根目录
REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

# 2. 检查是否安装了 goimports
if ! command -v goimports >/dev/null 2>&1; then
    echo "Error: 'goimports' not found. Please install it: go install golang.org/x/tools/cmd/goimports@latest"
    exit 1
fi

# 3. 获取暂存区(Staged)的所有 .go 文件
staged_go_files=$(git diff --cached --name-only --diff-filter=ACMR | grep "\.go$")

# 4. 如果没有 Go 文件变更，直接退出
if [ -z "$staged_go_files" ]; then
    exit 0
fi

# 5. 格式化并重新提交
echo "Running goimports on staged Go files..."

# 使用 xargs 将文件列表传给 goimports
# -w: 把结果写回文件
echo "$staged_go_files" | xargs goimports -w

# 再次 git add 这些文件
# 因为 goimports 可能修改了代码格式，需要重新将变化加入暂存区
echo "$staged_go_files" | xargs git add

echo "Done. Go files formatted and re-staged."
